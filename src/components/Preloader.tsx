import { useState, useEffect } from "react";
import { motion, AnimatePresence } from "framer-motion";
import type { CSSProperties } from "react";
import { useAudio } from "@/hooks/AudioContext";

interface PreloaderProps {
  onComplete: () => void;
}

// Styles
const wrapperStyle: CSSProperties = {
  position: "relative",
  width: "300px",
  height: "300px",
};
const svgStyle: CSSProperties = {
  position: "absolute",
  top: 0,
  left: 0,
  width: "100%",
  height: "100%",
  transition: "transform 0.1s ease-out",
};

const Preloader = ({ onComplete }: PreloaderProps) => {
  const [progress, setProgress] = useState(0);
  const [isExiting, setIsExiting] = useState(false);
  const { initAudio, playAudio } = useAudio();
  const [showButton, setShowButton] = useState(false);

  useEffect(() => {
    const duration = 2000;
    const interval = 10;
    const increment = 100 / (duration / interval);

    const timer = setInterval(() => {
      setProgress((prev) => {
        const next = prev + increment;
        if (next >= 100) {
          clearInterval(timer);
          setTimeout(() => setShowButton(true), 500); // ADD THIS LINE
          return 100;
        }
        return next;
      });
    }, interval);

    return () => clearInterval(timer);
  }, [onComplete]);

  const handleEnter = async () => {
    initAudio(); // create audio
    playAudio(); // âœ… allowed now (user gesture)
    await requestGyroPermission();
    setIsExiting(true);
    setTimeout(onComplete, 600);
  };

  const requestGyroPermission = async () => {
    if (
      typeof DeviceOrientationEvent !== "undefined" &&
      typeof (DeviceOrientationEvent as any).requestPermission === "function"
    ) {
      const permission = await (
        DeviceOrientationEvent as any
      ).requestPermission();
      return permission === "granted";
    }
    return true; // Android / non-iOS
  };

  return (
    <AnimatePresence>
      {!isExiting && (
        <motion.div
          initial={{ opacity: 1 }}
          exit={{ opacity: 0 }}
          transition={{ duration: 0.6, ease: "easeInOut" }}
          className="fixed inset-0  flex flex-col items-center justify-center bg-background"
        >
          {/* Grid Background */}
          <div className="absolute inset-0 grid-background opacity-80" />
          {/* Character SVGs */}
          <div style={wrapperStyle}>
            <svg
              style={{
                ...svgStyle,
                // transform: `translate(${-offset.x * 5}px, ${-offset.y * 5}px)`,
              }}
              version="1.1"
              id="Layer_1"
              xmlns="http://www.w3.org/2000/svg"
              x="0px"
              y="0px"
              width="100%"
              viewBox="0 0 464 768"
              enable-background="new 0 0 464 768"
            >
              <path
                fill="#3d3d3d"
                opacity="1.000000"
                stroke="none"
                d=" M379.248871,548.752319   C362.353088,531.624329 343.439575,517.901489 322.160126,507.417847   C318.548676,505.638641 316.447083,505.707245 313.662964,509.454651   C299.251678,528.852112 279.308014,539.741516 255.943466,544.050537   C227.916672,549.219360 201.638016,544.454407 177.989014,527.787415   C170.833420,522.744385 164.543320,516.777710 159.690231,509.543060   C157.406662,506.138855 155.643494,505.847382 152.120850,507.622528   C99.772049,534.002136 65.038895,575.123474 48.341049,631.344299   C46.356522,638.026062 45.045429,644.910950 43.504684,651.720337   C42.704632,655.256226 43.937748,656.902588 47.870804,656.868408   C64.201920,656.726196 80.535538,656.727600 96.866821,656.856812   C100.585068,656.886230 102.004326,655.547180 101.694290,651.871338   C101.485214,649.392334 101.518311,646.856445 101.784142,644.382629   C102.168037,640.810059 104.252899,638.440918 107.916046,638.290649   C111.266998,638.153259 113.675430,639.934204 114.369148,643.355713   C114.795494,645.458496 115.032150,647.636841 115.037399,649.781982   C115.081879,667.947388 115.058044,686.112915 115.038422,704.278442   C115.036804,705.774841 115.067932,707.296997 114.819679,708.762451   C114.171051,712.591370 112.331696,715.417419 107.970238,715.225220   C103.605072,715.032715 101.958611,712.039856 101.744560,708.180054   C101.532608,704.357788 101.524002,700.510376 101.690308,696.685486   C101.827950,693.519714 100.725075,692.165344 97.418320,692.186768   C82.419899,692.283569 67.420204,692.275085 52.421654,692.187134   C49.228958,692.168396 47.859249,693.387695 47.937771,696.595398   C48.027401,700.256775 47.993122,703.930603 47.794022,707.587097   C47.564354,711.805115 45.415127,714.811523 40.995087,714.591736   C36.737247,714.380066 34.544556,711.574646 34.649845,707.155640   C34.721275,704.157654 34.544006,701.151123 34.684032,698.158020   C34.840382,694.815857 34.624229,692.101746 30.735941,690.601562   C28.036917,689.560303 27.650688,686.600159 27.629480,683.755859   C27.480711,663.803223 30.423298,644.297119 36.214081,625.239197   C52.896549,570.335876 86.559769,529.001892 136.373749,500.797150   C149.445587,493.395874 163.319962,487.639923 177.855545,483.738007   C182.173553,482.578857 183.709442,480.499176 183.741364,476.079956   C183.817123,465.595673 184.267044,455.108704 184.820389,444.636261   C185.008163,441.082703 183.779800,439.291016 180.494217,437.887085   C158.667542,428.560242 139.860519,415.134552 125.283005,396.191711   C118.747803,387.699524 113.350281,378.515381 109.599030,368.450928   C108.546806,365.627838 107.278748,364.557007 104.088478,365.379120   C72.384491,373.549316 48.832550,343.803589 53.325554,316.739258   C56.372044,298.388184 66.130051,286.074432 83.926849,280.388885   C89.383995,278.645477 95.127419,279.871002 100.284546,279.473419   C100.284546,270.254608 100.624123,261.335144 100.220100,252.449478   C99.064651,227.037704 96.261749,201.576080 104.825897,176.747345   C120.624771,130.944046 151.075745,99.797241 197.604172,85.619766   C273.411957,62.520691 355.115082,108.451279 372.456360,188.853622   C376.001343,205.289902 376.089203,221.791611 374.610504,238.449478   C373.522217,250.709106 373.080536,263.026123 372.347626,275.317352   C372.190125,277.958313 372.476776,279.924500 376.073547,279.433502   C396.046661,276.707031 412.545319,289.898926 418.812927,306.260559   C428.521759,331.605499 415.177887,359.107239 389.719177,365.775421   C381.817017,367.845123 374.240997,366.972015 366.701080,364.323578   C365.948822,364.059357 365.121857,364.007782 363.976318,363.790527   C359.949432,374.383881 355.139130,384.406036 348.485626,393.431488   C334.514435,412.383362 316.448883,426.212677 295.127838,435.925201   C288.208191,439.077393 288.435822,438.980072 288.950012,446.561188   C289.636932,456.689880 290.008087,466.846924 290.209839,476.997833   C290.279510,480.504517 291.238739,482.205139 294.852966,483.293640   C362.957916,503.805542 409.394562,547.802063 434.852478,613.901611   C443.342468,635.945190 446.819336,659.163818 447.361816,682.796204   C447.450317,686.651978 446.605835,689.812195 442.701080,691.242554   C440.438690,692.071289 440.352844,693.758545 440.350281,695.651184   C440.344604,699.817505 440.356842,703.984375 440.289246,708.149902   C440.224792,712.121338 437.995209,714.558777 434.212250,714.776245   C430.415222,714.994507 427.843048,712.808899 427.512817,708.853760   C427.181091,704.880066 427.075958,700.876831 427.096619,696.887634   C427.113434,693.640625 426.009796,691.927490 422.483490,691.943176   C407.151642,692.011169 391.819214,691.985168 376.487152,691.946289   C373.578125,691.938904 372.222107,693.128174 372.309052,696.141968   C372.424316,700.137939 372.398376,704.142944 372.278320,708.139404   C372.159332,712.100464 370.444885,714.937317 366.130859,715.225037   C361.781250,715.515076 359.765503,712.881653 359.192749,708.957703   C358.905884,706.992493 358.925354,704.972595 358.923676,702.977295   C358.909088,685.478394 358.897461,667.979431 358.953522,650.480652   C358.960938,648.167908 359.177094,645.822937 359.607330,643.551697   C360.323120,639.773438 362.927582,638.385498 366.577423,638.716187   C370.142426,639.039246 371.936340,641.244995 372.230927,644.607544   C372.462891,647.255188 372.443085,649.941650 372.312408,652.599915   C372.164185,655.615540 373.427399,656.735657 376.425690,656.721985   C393.424286,656.644592 410.423889,656.618408 427.422089,656.732849   C431.166779,656.758057 432.026642,655.267517 431.383575,651.847656   C428.232788,635.092896 423.498901,618.815430 416.419647,603.300354   C407.212128,583.120728 394.818604,565.053589 379.248871,548.752319  M161.812347,256.376984   C154.675507,259.592499 147.613586,262.990509 140.376572,265.962036   C135.186691,268.093018 130.264618,271.523102 124.403625,271.230072   C120.194130,271.019592 118.874336,272.915344 118.373001,276.577209   C117.043571,286.287689 115.404129,295.957520 114.191093,305.681335   C113.613998,310.307404 111.447632,311.670593 106.934746,311.457825   C102.108917,311.230255 102.881836,308.038239 102.743355,305.166016   C102.623039,302.670685 102.658760,300.167725 102.630783,297.668091   C102.608467,295.674347 102.057068,293.819275 99.866188,293.511719   C97.095161,293.122681 94.415016,292.305054 91.476601,292.669312   C67.938751,295.586975 59.678661,323.487244 71.258339,340.535126   C78.452637,351.126709 89.907463,355.924164 99.981224,352.826752   C102.041267,352.193329 103.992493,351.519562 103.559105,348.912994   C102.653389,343.465759 101.672180,338.008911 96.530952,334.597809   C91.257454,331.098907 85.990883,327.588226 80.771935,324.008850   C76.683540,321.204926 75.526108,317.638794 77.454155,314.258636   C79.493759,310.682922 83.344757,309.920044 87.882797,312.719604   C93.264862,316.039825 98.380196,319.789246 103.668297,323.265747   C110.800644,327.954620 114.667725,334.709869 116.150276,342.924622   C122.951096,380.607666 145.475128,406.444550 179.000443,422.360107   C218.037430,440.892303 257.824371,439.932861 296.432037,420.453461   C321.622803,407.743500 340.704224,388.573975 350.532043,361.494781   C353.286987,353.903931 355.657074,346.081390 358.504486,338.580048   C363.981415,324.151520 377.587158,317.925659 390.322632,311.372925   C393.190277,309.897491 395.815979,311.866302 397.317902,314.629791   C399.150391,318.001526 398.019989,320.942017 395.181580,322.964661   C390.981903,325.957306 386.505890,328.560974 382.162415,331.353394   C378.372284,333.790070 374.334015,336.114746 372.242096,340.271484   C366.720886,351.242310 369.112701,352.499542 379.097321,353.615082   C381.556366,353.889832 384.045563,353.666321 386.523041,353.014709   C406.251160,347.826019 415.446503,322.864990 403.899841,305.700043   C396.968170,295.395630 386.027893,290.547577 375.690033,292.878937   C372.542816,293.588684 371.121674,294.877289 371.255127,298.221100   C371.366943,301.023193 371.156769,303.916534 370.554504,306.651703   C369.455017,311.644867 365.114777,309.930817 361.920105,310.280975   C358.641388,310.640289 358.924103,308.019806 358.640686,305.875214   C357.617523,298.133057 356.776306,290.353851 355.366272,282.680542   C354.458527,277.740570 354.612061,272.517853 352.398346,267.502747   C346.142578,270.193573 340.230530,271.601593 333.650146,270.722595   C321.280914,269.070312 310.550842,263.381683 299.687164,257.986908   C277.377625,246.908234 253.895187,240.839584 228.925705,241.499603   C205.897202,242.108307 183.760803,247.153046 161.812347,256.376984  M249.955734,447.636444   C234.118042,449.401367 218.413040,448.428070 202.910370,444.896851   C199.056366,444.019012 198.399277,445.319061 198.097534,448.707794   C197.432358,456.178192 197.662460,463.680725 197.087006,471.127502   C196.590485,477.552856 197.713913,484.364685 195.210999,490.304474   C193.645691,494.019196 194.461365,495.625916 196.942062,497.775238   C207.679733,507.078430 220.042267,511.713470 234.316849,512.018921   C250.172684,512.358215 264.122223,507.788330 276.225525,497.590881   C277.822937,496.245026 280.207672,494.839355 279.192627,492.359619   C276.121216,484.856110 277.072327,476.996002 276.664673,469.249573   C276.222046,460.838806 275.745056,452.429901 275.261688,443.631683   C266.786987,444.640289 259.015594,447.395630 249.955734,447.636444  M237.498917,195.981186   C202.964203,195.665573 169.793335,202.621902 137.635010,214.841660   C130.014435,217.737381 122.474228,220.884109 115.454010,225.090836   C112.489380,226.867294 111.271858,229.553009 113.154800,232.707535   C114.826889,235.508820 117.411560,236.264282 120.453186,234.625427   C121.331406,234.152222 122.249039,233.752151 123.148689,233.318726   C159.543976,215.784378 197.985092,206.748962 238.338989,206.979568   C269.892975,207.159897 300.347717,213.888687 329.772522,225.269394   C336.767029,227.974655 343.608704,230.988281 350.214569,234.552170   C353.602478,236.379944 357.281311,236.936493 359.278961,232.910568   C361.059845,229.321472 359.098053,226.541855 355.634308,224.840927   C353.246216,223.668213 350.928223,222.345169 348.505920,221.250778   C313.533844,205.450531 277.002014,196.427826 237.498917,195.981186  M184.448349,504.032593   C177.880661,496.505035 176.658630,496.238922 170.251678,500.941254   C180.974884,521.132385 216.276871,536.174927 245.149490,532.454102   C268.635590,529.427490 288.808716,520.128723 303.861206,500.633179   C295.352234,496.097565 295.360291,496.104340 290.140381,502.299683   C289.068939,503.571381 287.997559,504.863129 286.782623,505.991058   C257.705963,532.985474 210.793823,531.257812 184.448349,504.032593  M265.646667,174.577454   C269.138916,173.879608 271.705780,171.935089 271.417480,168.236374   C271.141449,164.694992 268.340973,163.357208 264.968781,163.355118   C245.328339,163.342972 225.687897,163.335495 206.047455,163.346680   C202.404236,163.348755 199.671677,164.978241 199.586517,168.772430   C199.508224,172.259689 202.076874,174.016693 205.383316,174.517960   C206.526489,174.691284 207.707870,174.644333 208.871811,174.644241   C227.513611,174.642853 246.155411,174.632751 265.646667,174.577454  M379.647522,670.202820   C378.314453,670.217468 376.980194,670.275513 375.648590,670.238159   C372.493011,670.149719 372.363861,672.226135 372.316589,674.586365   C372.265228,677.148743 372.911835,678.706604 375.899078,678.697327   C394.064331,678.640869 412.229919,678.656799 430.395294,678.682007   C432.708435,678.685181 433.533081,677.650757 433.724304,675.366699   C434.052917,671.441833 432.541840,670.108398 428.603760,670.147705   C412.606323,670.307617 396.606293,670.209290 379.647522,670.202820  M71.500000,678.820496   C79.998558,678.820496 88.498276,678.739197 96.995087,678.861084   C100.312340,678.908691 101.796936,677.898682 101.738998,674.283508   C101.681030,670.665955 99.802101,670.283020 96.948975,670.292908   C79.951973,670.351868 62.954552,670.361450 45.957596,670.299194   C43.044109,670.288513 41.282463,670.806519 41.199833,674.344055   C41.113770,678.028503 42.742241,678.900024 46.004673,678.852295   C54.168190,678.732788 62.334694,678.817017 71.500000,678.820496  z"
              />
            </svg>

            <svg
              style={{
                ...svgStyle,
                transform: `translate(${(progress / 100) * 12 - 6}px, ${12}px)`,
              }}
              version="1.1"
              id="Layer_1"
              xmlns="http://www.w3.org/2000/svg"
              x="0px"
              y="0px"
              width="100%"
              viewBox="0 0 464 768"
              enable-background="new 0 0 464 768"
            >
              <path
                fill="#3d3d3d"
                opacity="1.000000"
                stroke="none"
                d=" M215.407593,343.433990   C228.095627,351.460419 240.411789,351.507263 252.664581,343.369995   C255.187744,341.694305 257.667297,339.943970 260.951996,341.386993   C265.870178,343.547668 266.372681,349.275208 261.667877,353.168304   C253.652817,359.800537 244.132370,362.645325 233.897644,362.758545   C224.496002,362.862610 215.944412,359.753906 208.120804,354.556305   C202.994843,351.150879 201.527573,347.681610 203.843689,343.975403   C206.243759,340.134918 209.376709,339.926270 215.407593,343.433990  z"
              />
              <path
                fill="#3d3d3d"
                opacity="1.000000"
                stroke="none"
                d=" M177.659439,310.981232   C177.670029,306.664337 177.598648,302.838745 177.714157,299.018829   C177.838440,294.909607 180.061203,292.328918 184.155762,292.233093   C187.948944,292.144379 190.481216,294.345764 190.802292,298.256836   C191.414383,305.712952 191.440063,313.200653 190.744690,320.645660   C190.368484,324.673462 187.684875,327.090546 183.643814,326.783142   C179.815445,326.491913 177.874390,323.759705 177.720901,319.951324   C177.607162,317.129669 177.673584,314.300720 177.659439,310.981232  z"
              />
              <path
                fill="#3d3d3d"
                opacity="1.000000"
                stroke="none"
                d=" M286.113159,326.852905   C281.451233,325.858704 279.731049,322.976471 279.725464,318.816376   C279.716980,312.484772 279.609924,306.150818 279.748016,299.822327   C279.855347,294.902924 282.502411,291.887207 286.468201,292.171478   C290.821045,292.483490 293.059479,295.240387 293.156921,299.453094   C293.310944,306.113586 293.338715,312.784576 293.140350,319.442810   C293.017273,323.574005 290.837463,326.304413 286.113159,326.852905  z"
              />
            </svg>
          </div>

          {/* Center content */}
          <div className="relative flex flex-col items-center gap-8">
            {/* Name with stagger animation */}
            <motion.div className="flex overflow-hidden">
              {"PORTFOLIO".split("").map((letter, i) => (
                <motion.span
                  key={i}
                  className="text-3xl md:text-5xl font-bold tracking-[0.3em] text-foreground"
                  initial={{ y: 60, opacity: 0 }}
                  animate={{ y: 0, opacity: 1 }}
                  transition={{
                    duration: 0.5,
                    delay: i * 0.05,
                    ease: [0.22, 1, 0.36, 1],
                  }}
                >
                  {letter}
                </motion.span>
              ))}
            </motion.div>

            {/* Progress bar */}
            {/* Progress bar */}
            <AnimatePresence mode="wait">
              {!showButton ? (
                <motion.div
                  key="progress"
                  initial={{ opacity: 0, width: 0 }}
                  animate={{ opacity: 1, width: 200 }}
                  exit={{ opacity: 0, scale: 0.8 }}
                  transition={{ duration: 0.5, delay: 0.5 }}
                  className="relative h-[2px] bg-border overflow-hidden"
                >
                  <motion.div
                    className="absolute inset-y-0 left-0 bg-foreground"
                    style={{ width: `${progress}%` }}
                    transition={{ ease: "linear" }}
                  />
                </motion.div>
              ) : (
                <motion.button
                  onClick={handleEnter}
                  initial={{ opacity: 0, scale: 0.8, y: 10 }}
                  animate={{ opacity: 1, scale: 1, y: 0 }}
                  whileHover={{ y: -4 ,scale: 1.05}}
                  whileTap={{ scale: 0.96 }}
                  transition={{
                    duration: 0.6,
                    ease: [0.22, 1, 0.36, 1],
                  }}
                  className="px-8 py-3 bg-primary text-primary-foreground rounded-full text-sm font-medium hover:shadow-lg"
                >
                  Enter
                </motion.button>
              )}
            </AnimatePresence>

            {/* Percentage */}
            <motion.span
              initial={{ opacity: 0 }}
              animate={{ opacity: 1 }}
              transition={{ delay: 0.6 }}
              className="text-sm font-mono text-muted-foreground tracking-widest"
            >
              {Math.round(progress)}%
            </motion.span>
          </div>

          {/* Bottom text */}
          <motion.p
            initial={{ opacity: 0, y: 20 }}
            animate={{ opacity: 1, y: 0 }}
            transition={{ delay: 0.8 }}
            className="absolute bottom-12 text-xs text-muted-foreground tracking-[0.2em] uppercase"
          >
            Loading experience
          </motion.p>
        </motion.div>
      )}
    </AnimatePresence>
  );
};

export default Preloader;
